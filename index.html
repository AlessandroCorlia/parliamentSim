<!--TODO: 
  - Aggiornare il fatto delle coalizioni di governo (seggi uguali, includere il partito di centro)
  - Grafica di opposizione e maggioranza
-->

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create your own Parliament</title>
<style>
  body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; background: radial-gradient(circle at center,#f1f2f6,#dfe3e8); margin:0; display:flex; height:100vh; color:#2c2f33; overflow:hidden; }
  #menu { background: linear-gradient(180deg,#f7f8fa 0%,#e9eaee 100%); box-shadow:2px 0 10px rgba(0,0,0,0.1); width:300px; padding:25px; display:flex; flex-direction:column; border-radius:0 16px 16px 0; }
  h1 { font-size:20px; text-align:center; margin-bottom:20px; color:#2e4a7d; border-bottom:2px solid #d1a654; padding-bottom:8px; }
  #titoloParlamento {position: absolute; top: 30px; text-align: center; font-size: 26px; font-weight: 600; color: #2e4a7d; letter-spacing: 0.6px; text-shadow: 0 2px 3px rgba(0,0,0,0.1); user-select: text;}
  form { display:flex; flex-direction:column; gap:10px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 3px 6px rgba(0,0,0,0.08); }
  input, select { padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
  button { padding:10px; background:linear-gradient(90deg,#2e4a7d,#1f345a); color:white; border:none; border-radius:6px; cursor:pointer; transition:0.3s; }
  button:hover { transform:scale(1.02); background:linear-gradient(90deg,#3a5fa2,#2e4a7d); }
  #legenda { margin-top:15px; overflow-y:auto; flex-grow:1; font-size:13px; }
  .colore-box {width: 20px; height: 20px; border-radius: 50%;margin-right: 8px;}
  .partito-box { display:flex; align-items:center; justify-content:space-between; background:#f4f6f8; padding:6px 10px; border-radius:6px; margin-bottom:5px; }
  .partito-info { display:flex; align-items:center; gap:5px; }
  .partito-btns button { margin-left:4px; padding:4px 6px; font-size:11px; }
  #percentuale-riempimento { text-align:center; font-weight:bold; margin-top:10px; }
  #main { flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; }
  svg { margin-top:20px; }
  .voto-attivo { animation:votoFlash 0.3s ease-in-out; }
  @keyframes votoFlash { 0% { opacity:1; transform:scale(1); } 50% { opacity:0.3; transform:scale(1.4); } 100% { opacity:1; transform:scale(1); } }
  #btnVota, #btnReset, #btnPdC { display:none; margin-top:20px; padding:14px 26px; font-size:16px; font-weight:600; color:#fff; border:2px solid #d1a654; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.2); cursor:pointer; transition:0.2s; letter-spacing:0.5px; }
  #btnVota:hover, #btnReset:hover, #btnPdC:hover { transform:scale(1.04); box-shadow:0 6px 12px rgba(0,0,0,0.25); }
  #btnPdC { background:linear-gradient(180deg,#2e4a7d 0%,#22365e 100%); }
  #btnReset { background:linear-gradient(180deg,#c22 0%,#911 100%); }
  #btnVota { background:linear-gradient(180deg,#2e4a7d 0%,#22365e 100%); }
  #presidente, #pdcDiv { font-size:18px; margin-top:15px; color:#2e4a7d; font-weight:600; }
  #editFormContainer { display:none; position:absolute; top:50px; left:50%; transform:translateX(-50%); background:white; padding:15px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.25); z-index:10; }
</style>
</head>
<body>
<div id="menu">
  <h1>Gestione Partiti</h1>
  <form id="partitoForm">
    <input type="text" id="nome" placeholder="Nome partito" required>
    <input type="color" id="colore" value="#ff0000">
    <select id="ideologia" required>
      <option value="">-- Ideologia --</option>
      <option value="sinistra">Sinistra</option>
      <option value="centro">Centro</option>
      <option value="destra">Destra</option>
    </select>
    <input type="number" id="percentuale" placeholder="%" min="0" max="100" required>
    <button type="submit">Aggiungi Partito</button>
  </form>
  <div id="legenda"></div>
  <div id="percentuale-riempimento">Riempimento parlamento: 0%</div>
</div>

<div id="main">
  <h2 id="titoloParlamento">Il Tuo Parlamento</h2>
  <svg id="parlamento" width="800" height="450"></svg>
  <button id="btnVota">üó≥Ô∏è Eleggi Presidente del Parlamento</button>
  <button id="btnPdC">üë§ Nomina Presidente del Consiglio</button>
  <button id="btnReset">‚öñÔ∏è Sciogli Parlamento</button>
  <div id="presidente"></div>
  <div id="pdcDiv"></div>
</div>

<div id="editFormContainer">
  <h3>Modifica Partito</h3>
  <form id="editForm">
    <input type="text" id="editNome" required>
    <input type="color" id="editColore">
    <select id="editIdeologia" required>
      <option value="sinistra">Sinistra</option>
      <option value="centro">Centro</option>
      <option value="destra">Destra</option>
    </select>
    <input type="number" id="editPercentuale" min="0" max="100" required>
    <button type="submit">Salva Modifica</button>
    <button type="button" id="editCancel">Annulla</button>
  </form>
</div>

<script>
const SEGGI_TOTALI = 400;
const RIGHE = 5;
let partiti = JSON.parse(localStorage.getItem('partitiSalvati')) || [];
let presidente = JSON.parse(localStorage.getItem('presidenteSalvato')) || null;
let presidenteConsiglio = JSON.parse(localStorage.getItem('presidenteConsiglio')) || null;
let editingIndex = null;

const form = document.getElementById('partitoForm');
const parlamento = document.getElementById('parlamento');
const legenda = document.getElementById('legenda');
const btnVota = document.getElementById('btnVota');
const btnReset = document.getElementById('btnReset');
const btnPdC = document.getElementById('btnPdC');
const presidenteDiv = document.getElementById('presidente');
const pdcDiv = document.getElementById('pdcDiv');
const percentualeDiv = document.getElementById('percentuale-riempimento');

const editFormContainer = document.getElementById('editFormContainer');
const editForm = document.getElementById('editForm');
const editNome = document.getElementById('editNome');
const editColore = document.getElementById('editColore');
const editIdeologia = document.getElementById('editIdeologia');
const editPercentuale = document.getElementById('editPercentuale');
const editCancel = document.getElementById('editCancel');

aggiornaLegenda();
disegnaParlamento();
aggiornaPresidente();
aggiornaPdC();

form.addEventListener('submit', e=>{
  e.preventDefault();
  const nome = document.getElementById('nome').value;
  const colore = document.getElementById('colore').value;
  const ideologia = document.getElementById('ideologia').value;
  const percentuale = parseFloat(document.getElementById('percentuale').value);
  const totEsistente = partiti.reduce((s,p)=>s+p.percentuale,0);
  if(totEsistente+percentuale>100) return alert(`Non puoi inserire pi√π di ${100-totEsistente}%`);
  partiti.push({nome,colore,ideologia,percentuale});
  salvaPartiti();
  form.reset();
});

function salvaPartiti(){
  localStorage.setItem('partitiSalvati', JSON.stringify(partiti));
  localStorage.setItem('presidenteSalvato', JSON.stringify(presidente));
  localStorage.setItem('presidenteConsiglio', JSON.stringify(presidenteConsiglio));
  if(!presidente || partiti.length<SEGGI_TOTALI) presidente=null;
  if(!presidenteConsiglio) presidenteConsiglio=null;
  aggiornaLegenda();
  disegnaParlamento();
  aggiornaPresidente();
  aggiornaPdC();
}

function assegnaSeggi(){ return partiti.map(p=>({...p, seggi: Math.round(p.percentuale/100*SEGGI_TOTALI)})); }

function aggiornaLegenda(){
  legenda.innerHTML='';
  const dati=assegnaSeggi();
  dati.forEach((p,i)=>{
    const box=document.createElement('div');
    box.className='partito-box';
    const info=document.createElement('div');
    info.className='partito-info';
    const colore=document.createElement('div');
    colore.className='colore-box';
    colore.style.background=p.colore;
    const testo=document.createElement('span');
    testo.textContent=`${p.nome} (${p.percentuale}%) - ${p.ideologia} - ${p.seggi} seggi`;
    info.appendChild(colore); info.appendChild(testo);

    const btns=document.createElement('div'); btns.className='partito-btns';
    const btnDel=document.createElement('button'); btnDel.textContent='‚ùå';
    btnDel.onclick=()=>{ partiti.splice(i,1); presidente=null; presidenteConsiglio=null; salvaPartiti(); };
    const btnEdit=document.createElement('button'); btnEdit.textContent='‚úèÔ∏è';
    btnEdit.onclick=()=>{ editingIndex=i; editNome.value=p.nome; editColore.value=p.colore; editIdeologia.value=p.ideologia; editPercentuale.value=p.percentuale; editFormContainer.style.display='block'; };
    btns.appendChild(btnEdit); btns.appendChild(btnDel);

    box.appendChild(info); box.appendChild(btns);
    legenda.appendChild(box);
  });

  const totPerc = partiti.reduce((s,p)=>s+p.percentuale,0);
  percentualeDiv.textContent=`Riempimento parlamento: ${totPerc}%`;

  if(totPerc===100 && !presidente){ btnVota.style.display='block'; btnReset.style.display='block'; form.querySelectorAll('input,select,button').forEach(el=>el.disabled=true);}
  else{ btnVota.style.display='none'; if(totPerc===100) btnReset.style.display='block'; else btnReset.style.display='none'; form.querySelectorAll('input,select,button').forEach(el=>el.disabled=false);}
}

function disegnaParlamento(){
  parlamento.innerHTML=''; 
  const dati=assegnaSeggi();
  const cx=400,cy=400,raggioMax=300,step=30; 
  let startAngle=Math.PI;
  dati.forEach(p=>{
    let currentSeggi=0;
    const angleSpan=Math.PI*(p.seggi/SEGGI_TOTALI);
    for(let row=0;row<RIGHE;row++){
      const raggio=raggioMax-row*step;
      const seggiPerRiga=Math.round(p.seggi/RIGHE);
      for(let i=0;i<seggiPerRiga;i++){
        const frazione=i/seggiPerRiga;
        const angolo=startAngle+angleSpan*frazione;
        const x=cx+raggio*Math.cos(angolo); const y=cy+raggio*Math.sin(angolo);
        const cerchio=document.createElementNS('http://www.w3.org/2000/svg','circle');
        cerchio.setAttribute('cx',x); cerchio.setAttribute('cy',y); cerchio.setAttribute('r',5); cerchio.setAttribute('fill',p.colore);
        parlamento.appendChild(cerchio);
        currentSeggi++; if(currentSeggi>=p.seggi) break;
      }
    } startAngle+=angleSpan;
  });

  if(presidente){
    const presCircle=document.createElementNS('http://www.w3.org/2000/svg','circle');
    presCircle.setAttribute('cx',400); presCircle.setAttribute('cy',430); presCircle.setAttribute('r',12);
    presCircle.setAttribute('fill',presidente.colore); presCircle.setAttribute('stroke','#333'); presCircle.setAttribute('stroke-width','2');
    parlamento.appendChild(presCircle);
  }

  if(presidenteConsiglio){
    const pdcc=presidenteConsiglio;
    const pdcCircle=document.createElementNS('http://www.w3.org/2000/svg','circle');
    pdcCircle.setAttribute('cx',400); pdcCircle.setAttribute('cy',390); pdcCircle.setAttribute('r',12);
    pdcCircle.setAttribute('fill',pdcc.colore); pdcCircle.setAttribute('stroke','#333'); pdcCircle.setAttribute('stroke-width','2');
    parlamento.appendChild(pdcCircle);

    pdcc.ministri.forEach((m,i)=>{
      const dx=(i<3?-1:1)*(i%3+1)*25;
      const cerchio=document.createElementNS('http://www.w3.org/2000/svg','circle');
      cerchio.setAttribute('cx',400+dx); cerchio.setAttribute('cy',360); cerchio.setAttribute('r',8);
      cerchio.setAttribute('fill',m.colore); cerchio.setAttribute('stroke','#333'); cerchio.setAttribute('stroke-width','1');
      parlamento.appendChild(cerchio);
    });
  }
}

btnVota.addEventListener('click', simulaVotoPresidente);
btnPdC.addEventListener('click', nominaPdC);
btnReset.addEventListener('click', ()=>{ partiti=[]; presidente=null; presidenteConsiglio=null; salvaPartiti(); });

function scegliPresidente(){
  const dati=assegnaSeggi();
  let rand=Math.random()*dati.reduce((s,p)=>s+p.seggi,0);
  for(const p of dati){ if(rand<p.seggi) return p; rand-=p.seggi; }
  return dati[dati.length-1];
}

async function simulaVotoPresidente(){
  btnVota.style.display='none';
  const cerchi=[...parlamento.querySelectorAll('circle')];
  presidenteDiv.textContent="Votazione in corso...";
  for(let i=0;i<cerchi.length;i+=10){
    const subset=cerchi.slice(i,i+10); subset.forEach(c=>c.classList.add('voto-attivo'));
    await new Promise(r=>setTimeout(r,25));
    subset.forEach(c=>c.classList.remove('voto-attivo'));
  }
  presidente=scegliPresidente();
  localStorage.setItem('presidenteSalvato',JSON.stringify(presidente));
  aggiornaPresidente(); disegnaParlamento(); btnPdC.style.display='block';
}

function aggiornaPresidente(){ if(presidente) presidenteDiv.innerHTML=`Presidente del Parlamento: <span style="color:${presidente.colore};font-weight:bold">${presidente.nome}</span>`; else presidenteDiv.textContent=''; }

function nominaPdC() {
  if (!presidente) return; // sicurezza
  const dati = assegnaSeggi(); // aggiorna seggi

  const maxSeggi = Math.max(...dati.map(p => p.seggi));
  const topPartiti = dati.filter(p => p.seggi === maxSeggi);
  const pdcPartito = topPartiti[0];

  // scegli i ministri: 6 membri della stessa ideologia
  let stessiIdeologia = dati.filter(p => p.ideologia === pdcPartito.ideologia);
  if (stessiIdeologia.length === 0) stessiIdeologia = dati.filter(p => p.ideologia === 'centro');

  const ministri = [];
  while (ministri.length < 6) {
    const candidato = stessiIdeologia[Math.floor(Math.random() * stessiIdeologia.length)];
    ministri.push(candidato);
  }

  presidenteConsiglio = {
    nome: pdcPartito.nome,
    colore: pdcPartito.colore,
    ministri
  };

  localStorage.setItem('presidenteConsiglio', JSON.stringify(presidenteConsiglio));

  pdcDiv.innerHTML = `Presidente del Consiglio: <span style="color:${pdcPartito.colore};font-weight:bold">${pdcPartito.nome}</span>`;
  btnPdC.style.display = presidente ? 'block' : 'none';
  btnPdC.style.display = 'none';
  disegnaParlamento();
}

editForm.addEventListener('submit', e=>{
  e.preventDefault();
  const nome=editNome.value;
  const colore=editColore.value;
  const ideologia=editIdeologia.value;
  const percentuale=parseFloat(editPercentuale.value);
  const totEsistente=partiti.reduce((s,p,i)=>i!==editingIndex?s+p.percentuale:s,0);
  if(totEsistente+percentuale>100) return alert(`Non puoi inserire pi√π di ${100-totEsistente}%`);
  partiti[editingIndex]={nome,colore,ideologia,percentuale};
  editingIndex=null; editFormContainer.style.display='none'; presidente=null; presidenteConsiglio=null; salvaPartiti();
});
editCancel.addEventListener('click', ()=>{ editingIndex=null; editFormContainer.style.display='none'; });

function aggiornaPdC(){ if(presidenteConsiglio) pdcDiv.innerHTML=`Presidente del Consiglio: <span style="color:${presidenteConsiglio.colore}; font-weight:bold">${presidenteConsiglio.nome}</span>`; else pdcDiv.textContent=''; }
</script>
</body>
</html>
